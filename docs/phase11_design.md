# Phase 11: 検索機能の設計

## 1. 概要

カレンダー画面から遷移できる「検索機能」を実装し、過去のレシートデータからメモ内容（レシートメモ・明細メモ）で部分一致検索が行えるようにします。また、検索結果に該当する明細の合計金額から「検索結果の収支サマリー」を算出し、結果とともに表示します。

## 2. 画面レイアウト・UI仕様

### 2-1. 検索画面への導線（カレンダー画面）

- **追加箇所**: カレンダー画面（`/calendar`）のヘッダー右側
- **追加要素**: `Search` アイコンボタン。クリックすると検索画面（`/search`）へ遷移します。

### 2-2. 検索画面（`/search`）の構成

検索画面は以下の要素で構成します。

- **PageHeader**: タイトル「検索」、左側に「戻る」ボタン（カレンダー画面へ戻る）。
- **固定ヘッダーエリア（上部固定）**:
  1. **検索バー**:
     - テキスト入力フィールド。プレースホルダー：「検索」
     - 入力変更ごとにデバウンス（約300ms〜500ms）をかけて自動検索を実行します。
  2. **収支サマリー（検索結果合計）**:
     - 検索結果に該当するレシート（および明細）から計算した、収入合計・支出合計・合計残高を表示。
- **検索結果リスト（スクロール領域）**:
  - 検索条件に一致したレシートの一覧を表示（`ReceiptAccordionList` を再利用または拡張して表示）。
  - 検索キーワードが空の場合は検索を行わず、プレースホルダーのみの初期状態とします。

## 3. API・データ取得設計

検索に伴うデータ取得のため、新たに検索用APIを実装するか、既存のAPIを拡張します。

### 3-1. 検索用エンドポイント

- **パス**: `GET /api/search?q={キーワード}`
- **処理内容**:
  1. クエリパラメータ `q` を取得。
  2. `receipts`（レシート）と `lineItems`（明細）を結合（JOIN）。
  3. `receipts.memo`（レシートメモ）または `lineItems.memo`（明細メモ）に対し、SQLの `LIKE '%キーワード%'` などを用いて部分一致検索を行う。
  4. 該当するレシートおよびその配下の明細データをまとめて取得。
- **レスポンス形式**:
  ```json
  {
  	"receipts": [
  		/* レシート情報の配列（明細やカテゴリ情報等を含む） */
  	],
  	"summary": { "income": 10000, "expense": 5000, "total": 5000 }
  }
  ```
  ※サマリー情報はサーバー側で計算して返すか、クライアント側で取得したレシートデータから計算します。（今回はクライアント側で計算する方針でも容易に実装可能です）。

## 4. 既存コンポーネントの調整

- **`ReceiptAccordionList.svelte`**:
  検索結果として渡されたレシートデータの一覧を表示するために再利用します。検索結果では日付が連続しない場合があるため、カレンダーの「1日単位」とは異なる表示調整（例えば各レシートに日付を表示するなど）が必要になる可能性があります。

## 5. 実装ステップ

1. **検索画面のUIベース作成**: `/search/+page.svelte` ファイルの作成、固定ヘッダー（検索バー＋サマリー）のレイアウト構築。
2. **ルーティング追加**: `/calendar` のヘッダー右側に検索ボタン（`/search` へのリンク）を配置。
3. **検索APIの実装**: `/api/search/+server.ts` を作成し、DBに対する LIKE 検索とデータ整形ロジックを実装。
4. **検索処理・状態管理の結合**: 検索バーの入力に応じたAPIリクエスト（デバウンス処理）と、結果のリスト表示・サマリー計算の実装。
5. **UIのブラッシュアップ**: スクロール領域の調整や、検索ヒット時のハイライト（余力があれば）などの微調整。
